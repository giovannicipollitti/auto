<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Dashboard</title>

<!-- jsPDF per esportare PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- Leaflet (CDN) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<style>
  :root{
    --bg: linear-gradient(180deg,#072837,#01343a);
    --panel:#071822;
    --accent:#00aaff;
    --muted:#9fb6c6;
    --card: rgba(255,255,255,0.02);
    --text:#eaf8ff;
  }
  html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  .wrap{max-width:980px;margin:12px auto;padding:12px;display:flex;flex-direction:column;gap:12px}
  .panel{background:linear-gradient(180deg,var(--panel),#021017);padding:12px;border-radius:12px;border:1px solid rgba(0,160,220,0.06);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .logo-area{display:flex;align-items:center;gap:10px}
  .page-icon{width:40px;height:40px;border-radius:8px;object-fit:contain;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.03);padding:6px}
  .speed{font-family: 'Orbitron', monospace; font-size:88px; text-align:center; color:var(--text); margin:6px 0}
  .unit{font-size:14px;text-align:center;color:var(--muted);margin-bottom:6px}
  .smallstats{display:flex;gap:8px;justify-content:space-between;margin-top:8px}
  .stat{flex:1;background:var(--card);padding:10px;border-radius:8px;text-align:center;border:1px solid rgba(255,255,255,0.02)}
  .stat .label{font-size:12px;color:var(--muted)}
  .stat .val{font-size:18px;font-weight:700;color:var(--accent);margin-top:6px}
  .controls{display:flex;gap:8px;margin-top:10px}
  .btn{flex:1;padding:12px;border-radius:10px;border:none;background:linear-gradient(180deg,#08343c,#012024);color:var(--text);font-weight:700;cursor:pointer}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
  .btn.warn{background:linear-gradient(180deg,#5b0f0f,#3a0505)}
  .btn[disabled]{opacity:0.45;cursor:not-allowed}
  /* player */
  .player{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .file-row{display:flex;gap:8px;align-items:center}
  .file-btn{padding:8px 10px;border-radius:8px;background:linear-gradient(180deg,#032a31,#011417);border:1px solid rgba(0,160,220,0.06);cursor:pointer;color:var(--text)}
  .playlist{display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto;margin-top:6px}
  .track{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(0,0,0,0.18)}
  .footer{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
  .small{font-size:12px;color:var(--muted)}
  .controls-row{display:flex;gap:8px;align-items:center}

  /* --- mini map (full-width bottom) --- */
  .map-wrap{display:block}
  .map-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  #mapContainer{width:100%;height:260px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,0.6)}
  #mapContainer .resizer{height:8px;cursor:ns-resize;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);}
  /* make the map wrapper resizable by dragging resizer element */
  .map-controls{display:flex;gap:8px;align-items:center}
  .map-info{font-size:12px;color:var(--muted)}

  @media(min-width:900px){ .wrap{max-width:1100px} .speed{font-size:110px} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="topbar">
        <div class="logo-area">
          <!-- small static icon: place icon.png in the same folder -->
          <img src="icon.png" alt="icon" class="page-icon" onerror="this.style.display='none'">
          <div>
            <div style="font-weight:700;font-size:15px">Dashboard</div>
            <div style="font-size:12px;color:var(--muted)">Cruscotto GPS & Player</div>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-size:12px;color:var(--muted)" id="status">Idle</div>
          <div style="font-size:12px;color:var(--muted)" id="positionsCount">0 posizioni</div>
        </div>
      </div>

      <div class="speed" id="speed">0</div>
      <div class="unit">km/h</div>

      <div class="smallstats">
        <div class="stat"><div class="label">KM</div><div id="km" class="val">0.00</div></div>
        <div class="stat"><div class="label">Media</div><div id="avg" class="val">0.0</div></div>
        <div class="stat"><div class="label">Max</div><div id="max" class="val">0</div></div>
      </div>

      <div class="controls">
        <button id="start" class="btn">START</button>
        <button id="stop" class="btn ghost" disabled>STOP</button>
        <button id="reset" class="btn warn" disabled>RESET</button>
      </div>

      <div style="margin-top:10px;font-size:13px;color:var(--muted)">Tempo: <span id="time">00:00:00</span></div>
    </div>

    <div class="panel player">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">Player MP3</div>
        <div style="font-size:12px;color:var(--muted)" id="playerState">Idle</div>
      </div>

      <div class="file-row">
        <label class="file-btn">Carica MP3<input id="audioInput" type="file" accept="audio/*" multiple style="display:none"></label>
        <button id="addUrl" class="file-btn">Aggiungi URL</button>
        <button id="clearPl" class="file-btn">Svuota</button>
      </div>

      <div class="playlist" id="playlist"></div>

      <audio id="audio" controls style="width:100%;margin-top:6px"></audio>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="savePdf" class="btn">Salva report PDF</button>
        <button id="exportCsv" class="btn ghost">Esporta CSV</button>
      </div>

      <div class="footer">by Cipollitti Giovanni</div>
    </div>

    <!-- MAP SECTION: full-width bottom, resizable -->
    <div class="map-wrap panel" id="mapSection">
      <div class="map-header">
        <div style="font-weight:700">Mappa Tracciato</div>
        <div class="map-controls">
          <div class="map-info" id="mapInfo">Nessun punto</div>
          <button id="clearMap" class="file-btn ghost">Svuota Tracciato</button>
        </div>
      </div>
      <div id="mapContainer">
        <div id="map" style="width:100%;height:100%"></div>
        <div class="resizer" id="mapResizer" title="Trascina per ridimensionare"></div>
      </div>
    </div>

  </div>

<script>
/* ---------- Stato e variabili ---------- */
let running = false;
let watchId = null;
let startTime = null;
let endTime = null;
let elapsedTimer = null;
let lastPos = null;
let totalMeters = 0;
let samples = []; // velocità campionate (km/h)
let maxSpeed = 0;
let positionsLog = []; // storico {t,lat,lon,speed}
const staticLogoPath = 'icon.png'; // static icon included in PDF if present

/* ---------- UI references ---------- */
const speedEl = document.getElementById('speed');
const kmEl = document.getElementById('km');
const avgEl = document.getElementById('avg');
const maxEl = document.getElementById('max');
const timeEl = document.getElementById('time');
const statusEl = document.getElementById('status');
const positionsCountEl = document.getElementById('positionsCount');
const startBtn = document.getElementById('start');
const stopBtn = document.getElementById('stop');
const resetBtn = document.getElementById('reset');

/* ---------- funzioni utili ---------- */
function formatTime(ms){
  const s = Math.floor(ms/1000);
  const hh = String(Math.floor(s/3600)).padStart(2,'0');
  const mm = String(Math.floor((s%3600)/60)).padStart(2,'0');
  const ss = String(s%60).padStart(2,'0');
  return `${hh}:${mm}:${ss}`;
}
function toKm(m){ return m/1000; }

/* haversine (metri) */
function haversine(a,b){
  const R = 6371000;
  const toRad = x => x * Math.PI/180;
  const dLat = toRad(b.lat - a.lat);
  const dLon = toRad(b.lon - a.lon);
  const la = toRad(a.lat), lb = toRad(b.lat);
  const sin1 = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(la)*Math.cos(lb)*Math.sin(dLon/2)*Math.sin(dLon/2);
  const c = 2*Math.atan2(Math.sqrt(sin1), Math.sqrt(1-sin1));
  return R*c;
}

/* aggiorna UI statistica */
function updateStats(){
  const km = toKm(totalMeters);
  kmEl.textContent = km.toFixed(2);
  const avg = samples.length ? (samples.reduce((a,b)=>a+b,0)/samples.length) : 0;
  avgEl.textContent = avg.toFixed(1);
  maxEl.textContent = Math.round(maxSpeed);
  positionsCountEl.textContent = `${positionsLog.length} posizioni`;
  document.getElementById('mapInfo').textContent = `${positionsLog.length} punti`;
}

/* aggiorna velocità sul display */
function updateSpeedDisplay(v){
  speedEl.textContent = (Math.round(v*10)/10).toString();
}

/* ---------- GPS handling ---------- */
function onPos(p){
  const lat = p.coords.latitude;
  const lon = p.coords.longitude;
  const s = p.coords.speed; // m/s or null
  const t = Date.now();

  let speedKmh = 0;
  if (s !== null && !isNaN(s)) {
    speedKmh = s*3.6;
  } else if (lastPos) {
    // stima velocità da distanza/tempo (m/s) --> km/h
    const d = haversine(lastPos, {lat,lon});
    const dt = (t - lastPos.t)/1000;
    if (dt > 0.2) { // evita divisione per numeri molto piccoli
      const vms = d / dt;
      speedKmh = vms * 3.6;
    } else {
      speedKmh = samples.length ? samples[samples.length-1] : 0;
    }
  }

  // log position
  positionsLog.push({t, lat, lon, speed: speedKmh});

  // compute distance
  if (running && lastPos){
    const d = haversine(lastPos, {lat,lon});
    if (d > 0.5) totalMeters += d; // ignore tiny jitter
  }

  lastPos = {lat,lon,t};

  // record sample if running
  if (running){
    const sampleSpeed = speedKmh || (samples.length ? samples[samples.length-1] : 0);
    samples.push(sampleSpeed);
    if (sampleSpeed > maxSpeed) maxSpeed = sampleSpeed;
    updateStats();
  }

  updateSpeedDisplay(speedKmh);

  // add point to map if initialized
  try{ addPointToMap(lat, lon); } catch(e){ /* ignore */ }
}

/* error callback */
function onErr(e){
  console.warn('GPS error', e);
  statusEl.textContent = 'GPS error';
}

/* start/stop watchPosition */
function startWatch(){
  if (!('geolocation' in navigator)) { alert('Geolocation non supportata'); return; }
  if (watchId !== null) return;
  watchId = navigator.geolocation.watchPosition(onPos, onErr, {enableHighAccuracy:true, maximumAge:500, timeout:10000});
}
function stopWatch(){
  if (watchId !== null){ navigator.geolocation.clearWatch(watchId); watchId = null; }
}

/* ---------- controlli Start / Stop / Reset ---------- */
startBtn.addEventListener('click', ()=>{
  if (running) return;
  running = true;
  statusEl.textContent = 'Recording';
  startTime = Date.now();
  endTime = null;
  elapsedTimer = setInterval(()=> {
    timeEl.textContent = formatTime(Date.now()-startTime);
  },1000);
  // reset stats
  totalMeters = 0; samples = []; maxSpeed = 0; positionsLog = []; lastPos = null;
  clearMap();
  updateStats();
  startWatch();
  // bottoni
  startBtn.disabled = true;
  stopBtn.disabled = false;
  resetBtn.disabled = false;
});

stopBtn.addEventListener('click', ()=>{
  if (!running) return;
  running = false;
  statusEl.textContent = 'Stopped';
  clearInterval(elapsedTimer);
  stopWatch();
  endTime = Date.now();
  updateStats();
  startBtn.disabled = false;
  stopBtn.disabled = true;
  resetBtn.disabled = false;
  alert('Viaggio fermato. Puoi salvare il report in PDF.');
});

resetBtn.addEventListener('click', ()=>{
  if (!confirm('Azzerare tutti i dati?')) return;
  running = false;
  statusEl.textContent = 'Idle';
  clearInterval(elapsedTimer);
  stopWatch();
  startTime = null; endTime = null; totalMeters = 0; samples = []; maxSpeed = 0; positionsLog = []; lastPos = null;
  timeEl.textContent = '00:00:00';
  updateSpeedDisplay(0); updateStats();
  startBtn.disabled = false;
  stopBtn.disabled = true;
  resetBtn.disabled = true;
  clearMap();
});

/* ---------- Player MP3 (semplice) ---------- */
const audioInput = document.getElementById('audioInput');
const playlistEl = document.getElementById('playlist');
const audioEl = document.getElementById('audio');
const playerState = document.getElementById('playerState');
let playlist = [];

audioInput.addEventListener('change', ()=>{
  const files = Array.from(audioInput.files);
  files.forEach(f => {
    const url = URL.createObjectURL(f);
    const item = {name: f.name, url};
    playlist.push(item);
    renderTrack(item);
  });
});

function renderTrack(item){
  const div = document.createElement('div'); div.className = 'track';
  div.innerHTML = `<div style=\"max-width:70%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap\">${item.name}</div>`+
                   `<div>`+
                     `<button class=\"btn playBtn\" data-url=\"${item.url}\">Play</button>`+
                     `<button class=\"btn ghost removeBtn\" style=\"margin-left:6px\">X</button>`+
                   `</div>`;
  playlistEl.appendChild(div);
  div.querySelector('.playBtn').addEventListener('click', function(){
    audioEl.src = this.dataset.url;
    audioEl.play();
  });
  div.querySelector('.removeBtn').addEventListener('click', function(){
    // rimuovi dal DOM e dalla playlist
    const idx = playlist.findIndex(p=>p.url===item.url);
    if (idx>=0) playlist.splice(idx,1);
    div.remove();
    if (audioEl.src === item.url){ audioEl.pause(); audioEl.src = ''; playerState.textContent = 'Idle'; }
  });
}

document.getElementById('addUrl').addEventListener('click', ()=>{
  const url = prompt('Inserisci URL MP3 (http/https)');
  if (!url) return;
  const name = url.split('/').pop().split('?')[0];
  const item = {name: name || 'track', url};
  playlist.push(item);
  renderTrack(item);
});

document.getElementById('clearPl').addEventListener('click', ()=>{
  if (!confirm('Svuotare playlist?')) return;
  playlist = []; playlistEl.innerHTML = ''; audioEl.pause(); audioEl.src = ''; playerState.textContent = 'Idle';
});

audioEl.addEventListener('play', ()=> playerState.textContent = 'Playing');
audioEl.addEventListener('pause', ()=> playerState.textContent = 'Paused');
audioEl.addEventListener('ended', ()=> playerState.textContent = 'Idle');

/* ---------- Map (Leaflet) ---------- */
let map = null;
let mapMarker = null;
let mapPolyline = null;
let mapPoints = [];
const mapContainer = document.getElementById('map');

function initMap(){
  try{
    map = L.map('map', {zoomControl:false, attributionControl:false}).setView([45.4642,9.19], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    mapMarker = L.circleMarker([0,0],{radius:6,color:'#00aaff',fill:true,fillOpacity:1}).addTo(map);
    mapPolyline = L.polyline([], {color:'#00aaff',weight:3,opacity:0.9}).addTo(map);
  }catch(e){console.warn('Leaflet init failed',e);}
}

function addPointToMap(lat, lon){
  if (!map) return;
  const latlng = [lat, lon];
  mapPoints.push(latlng);
  mapPolyline.setLatLngs(mapPoints);
  mapMarker.setLatLng(latlng);
  if (mapPoints.length === 1) {
    map.setView(latlng, 16);
  } else {
    map.panTo(latlng, {animate:true,duration:0.6});
  }
}

function clearMap(){
  mapPoints = [];
  if (mapPolyline) mapPolyline.setLatLngs([]);
  if (mapMarker) mapMarker.setLatLng([0,0]);
  if (map) map.invalidateSize();
  document.getElementById('mapInfo').textContent = '0 punti';
}

// resizer logic for the map container
(function(){
  const resizer = document.getElementById('mapResizer');
  const container = document.getElementById('mapContainer');
  let dragging = false;
  let startY = 0;
  let startH = 0;
  resizer.addEventListener('mousedown', e => { dragging = true; startY = e.clientY; startH = container.offsetHeight; document.body.style.userSelect='none'; });
  window.addEventListener('mousemove', e => {
    if (!dragging) return;
    const dy = startY - e.clientY; // invert so dragging up increases height
    let newH = startH + dy;
    newH = Math.max(120, Math.min(window.innerHeight - 120, newH));
    container.style.height = newH + 'px';
    if (map) map.invalidateSize();
  });
  window.addEventListener('mouseup', ()=>{ if (dragging){ dragging=false; document.body.style.userSelect='auto'; } });
})();

// clear map button
document.getElementById('clearMap').addEventListener('click', ()=>{ if (!confirm('Svuotare il tracciato?')) return; clearMap(); });

/* ---------- Export PDF e CSV ---------- */
const { jsPDF } = window.jspdf;

document.getElementById('savePdf').addEventListener('click', async ()=>{
  const doc = new jsPDF({unit:'pt', format:'a4'});
  // header: try to load static icon if present (fetch first for better packaging support)
  let headerY = 40;
  try{
    const img = await loadImage(staticLogoPath);
    const maxW = 80;
    const aspect = img.width / img.height;
    const w = Math.min(maxW, img.width);
    const h = w / aspect;
    const c = document.createElement('canvas');
    c.width = w; c.height = h;
    const ctx = c.getContext('2d');
    ctx.drawImage(img,0,0,w,h);
    const imgData = c.toDataURL('image/png');
    doc.addImage(imgData, 'PNG', 40, 30, w, h);
    headerY = 30 + h + 10;
  }catch(e){
    // icon not found or failed to load - ignore (still produce PDF)
    console.warn('Icon not included in PDF:', e);
  }

  // title
  doc.setFontSize(18); doc.setTextColor(10,150,200);
  doc.text('Report Viaggio', 40, headerY + 16);
  doc.setFontSize(11); doc.setTextColor(200,200,200);
  const startStr = startTime ? new Date(startTime).toLocaleString() : '--';
  const endStr = endTime ? new Date(endTime).toLocaleString() : (running ? 'in corso' : '--');
  doc.text(`Inizio: ${startStr}`, 40, headerY + 44);
  doc.text(`Fine: ${endStr}`, 40, headerY + 62);
  doc.text(`KM percorsi: ${kmEl.textContent} km`, 40, headerY + 80);
  doc.text(`Vel. media: ${avgEl.textContent} km/h`, 40, headerY + 98);
  doc.text(`Vel. max: ${maxEl.textContent} km/h`, 40, headerY + 116);
  doc.text(`Tempo: ${timeEl.textContent}`, 40, headerY + 134);
  doc.text(`Posizioni loggate: ${positionsLog.length}`, 40, headerY + 152);

  // paginazione dati (prima 200 posizioni come esempio)
  let y = headerY + 182;
  doc.setFontSize(9);
  doc.setTextColor(180,180,180);
  doc.text('timestamp, lat, lon, speed_kmh', 40, y);
  y += 14;
  for (let i = 0; i < Math.min(200, positionsLog.length); i++){
    const p = positionsLog[i];
    const line = `${new Date(p.t).toISOString()}  ${p.lat.toFixed(6)}, ${p.lon.toFixed(6)}, ${Math.round(p.speed*10)/10}`;
    doc.text(line, 40, y);
    y += 12;
    if (y > 720){ doc.addPage(); y = 40; }
  }

  const name = `report_${new Date().toISOString().replace(/[:.]/g,'-')}.pdf`;
  doc.save(name);
});

function loadImage(src){
  // Try to fetch the resource and convert to blob first (better for packaged apps and CORS),
  // fallback to regular Image if fetch fails.
  return fetch(src).then(resp => {
    if (!resp.ok) throw new Error('fetch failed');
    return resp.blob();
  }).then(blob => new Promise((res,rej)=>{
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = ()=> { URL.revokeObjectURL(url); res(img); };
    img.onerror = (e)=>{ URL.revokeObjectURL(url); rej(e); };
    img.src = url;
  })).catch(()=>{
    // fallback
    return new Promise((res,rej)=>{
      const img = new Image();
      img.onload = ()=> res(img);
      img.onerror = rej;
      img.src = src;
    });
  });
}

/* ---------- inizializza UI & map on DOM ready ---------- */
updateSpeedDisplay(0);
updateStats();
timeEl.textContent = '00:00:00';

window.addEventListener('load', ()=>{
  // init leaflet map after load to ensure container size is set
  initMap();
  if (map) map.invalidateSize();
});
</script>
</body>
</html>